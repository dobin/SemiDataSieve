<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SemiDataSieve</title>
    <style>
        .nicebutton {
            padding: 5px 5px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f4f4f4;
        }
        
        .log-line {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .log-entry {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .log-key, .log-value {
            position: relative;
            cursor: pointer;
        }
        .log-key {
            font-weight: bold;
        }
        .log-value {
            background-color: white;
            padding: 3px 5px;
            border-radius: 3px;
        }
        
        .menu {
            width: 18em;
            background-color: #333;
            color: white;
        }
        .menu-head {
            background-color: #493f3f;
            color: white;
            padding: 20px;
        }
        .menu-quick {
            background-color: #3f493f;
            color: white;
            padding: 20px;
        }
        .menu-filter {
            background-color: #79825f;
            color: white;
            padding: 20px;
        }

        .popup {
            position: absolute;
            background: white;
            border: 1px solid black;
            padding: 5px;
            display: none;
            z-index: 100;
        }

        /* Container for each input field and the clear button */
.input-container {
    position: relative;
    display: inline-block;
}

/* Style for the clear button */
.clear-btn {
    padding-left: 3px;
    padding-right: 3px;
    margin-left: 3px;
    margin-right: 3px;
}

/* Optional hover effect */
.clear-btn:hover {
    color: red;
}

.lbl_width {
    width: 6.5em;
    display: inline-block;
}

.input-short {
    width: 8em;
}
    </style>
</head>

<body>
    <div class="log-container" id="log-container"></div>
    <div class="menu">
        <!-- Menu: Head -->
        <div class="menu-head">
            <h2>SemiDataSieve</h2>
            <br>
            key:value filtering<br>
            <br>
            <input type="file" id="fileInput">
            <button class="nicebutton" onclick="uploadFile()">Private Upload</button>
        </div>
        
        <!-- Menu: Quick -->
        <div class="menu-quick">
            <h2>Quick Filter</h2> <br>

            <label class="lbl_width">Include Key</label>
            <div class="input-container">
                <input class="input-short" type="text" id="quick-filter-include-key" onchange="quickFilterOnChange()">
                <button class="clear-btn" onclick="quickFilterClear('quick-filter-include-key')">X</button>
            </div>
            <br>
            <label class="lbl_width">Include Value</label>
            <div class="input-container">
                <input class="input-short" type="text" id="quick-filter-include-value" onchange="quickFilterOnChange()">
                <button class="clear-btn" onclick="quickFilterClear('quick-filter-include-value')">X</button>
            </div>
            <br><br>
            
            <label class="lbl_width">Exclude Key</label>
            <div class="input-container">
                <input class="input-short" type="text" id="quick-filter-exclude-key" onchange="quickFilterOnChange()">
                <button class="clear-btn" onclick="quickFilterClear('quick-filter-exclude-key')">X</button>
            </div>
            <br>
            <label class="lbl_width">Exclude Value</label>
            <div class="input-container">
                <input class="input-short" type="text" id="quick-filter-exclude-value" onchange="quickFilterOnChange()">
                <button class="clear-btn" onclick="quickFilterClear('quick-filter-exclude-value')">X</button>
            </div>
            <br><br>
            
            <button class="nicebutton" onclick="quickFilterAdd()">Add as filter</button>
        </div>
        
        <!-- Menu: Filter -->
        <div class="menu-filter">
            <h2>Filter</h2>
            <br>
            <div id="filter-container"></div>
        </div>
    </div>

    <!-- Popup Windows (one for key, value) -->
    <div class="popup" id="popup_key" onmouseenter="cancelHidePopup()" onmouseleave="hidePopup()">
        Key: 
        <button id="action-button-key-include">Include</button>
        <button id="action-button-key-exclude">Exclude</button>
    </div>
    <div class="popup" id="popup_value" onmouseenter="cancelHidePopup()" onmouseleave="hidePopup()">
        Value:
        <button id="action-button-value-include">Include</button>
        <button id="action-button-value-exclude">Exclude</button>
    </div>


    <!-- JavaScript yay -->
    <script>
        // The reference data. This is always unfiltered.
        let logs_orig = [
            { timestamp: "2025-03-08 12:00:00", level: "INFO", message: "System started" },
            { timestamp: "2025-03-08 12:05:00", level: "WARNING", message: "High memory usage detected" },
            { timestamp: "2025-03-08 12:10:00", level: "ERROR", message: "System crash" },
            { timestamp: "2025-03-08 12:10:00", nolevel: "ERROR", stuff: "0x1234", addr: 0x1235, offset: 0x643643, size: 0x23643,
                "info": "microsoft threat intelligence provider"
             }
        ];
        // The actual data. filtered from logs_orig
        let logs = logs_orig.slice();  // copy first
        
        // List of all filters
        let filters = [
            //{ type: "key", action: "include", key: "level", value: "" },
            //{ type: "key", action: "exclude", key: "level", value: "INFO" },
            //{ type: "value", action: "include", key: "", value: "memory" }
        ]

        // Popup menu data uargh
        let currentLogEntry = null;
        let currentKey = null;
        let currentValue = null;
        let hideTimeout = null;
        let popupShown = false;


        // Quick Filter

        function quickFilterClear(inputId) {
            document.getElementById(inputId).value = "";
        }

        function quickFilterOnChange() {
            refresh();
        }

        function quickFilterAdd() {
            const keyInclude = document.getElementById("quick-filter-include-key").value;
            const valueInclude = document.getElementById("quick-filter-include-value").value;
            const keyExclude = document.getElementById("quick-filter-exclude-key").value;
            const valueExclude = document.getElementById("quick-filter-exclude-value").value;

            if (keyInclude) {
                addFilter("key", "include", null, keyInclude, "");
            }
            if (valueInclude) {
                addFilter("value", "include", null, "", valueInclude);
            }
            if (keyExclude) {
                addFilter("key", "exclude", null, keyExclude, "");
            }
            if (valueExclude) {
                addFilter("value", "exclude", null, "", valueExclude);
            }

            // clear
            document.getElementById("quick-filter-include-key").value = "";
            document.getElementById("quick-filter-include-value").value = "";
            document.getElementById("quick-filter-exclude-key").value = "";
            document.getElementById("quick-filter-exclude-value").value = "";
        }


        // Menu Filter UI

        function menuFiltersRefresh() {
            const filterContainer = document.getElementById("filter-container"); 
            filterContainer.innerHTML = ""; // Clear previous filters

            if (filters.length === 0) {
                // show text if no filters are set
                const filterDiv = document.createElement("div");
                filterDiv.textContent = "Hover over a key or value to add a filter";
                filterContainer.appendChild(filterDiv);
                return;
            }

            filters.forEach((filter, index) => {
                const filterDiv = document.createElement("div");
                filterDiv.classList.add("filter-item");

                if (filter.type == "key") {
                    filterDiv.textContent = `${filter.action} ${filter.type}: ${filter.key} `;
                } else if (filter.type == "value") {
                    filterDiv.textContent = `${filter.action} ${filter.type}: ${filter.value} `;
                }
                
                // Add a remove button
                const removeButton = document.createElement("button");
                removeButton.textContent = "X";
                // make it bigger
                // margin
                removeButton.style.marginLeft = "3px";
                removeButton.style.marginRight = "3px";
                removeButton.style.paddingLeft = "3px";
                removeButton.style.paddingRight = "3px";
                removeButton.onclick = () => removeFilter(index);

                filterDiv.appendChild(removeButton);
                filterContainer.appendChild(filterDiv);
            });
        }


        // Filter Backend
        
        function addFilter(type, action, _logentry, key, value) {
            filters.push({
                type: type,
                action: action,
                key: key,
                value: value
            });
            refresh()
        }

        function removeFilter(index) {
            filters.splice(index, 1); // Remove the filter from the array
            refresh()
        }

        function filterOrigLogs(logs, filters) {
            // copy filters
            filters = filters.slice();

            // add quick filters
            const keyInclude = document.getElementById("quick-filter-include-key").value;
            const valueInclude = document.getElementById("quick-filter-include-value").value;
            const keyExclude = document.getElementById("quick-filter-exclude-key").value;
            const valueExclude = document.getElementById("quick-filter-exclude-value").value;
            if (keyInclude) {
                filters.push({ type: "key", action: "include", key: keyInclude, value: "" });
            }
            if (valueInclude) {
                filters.push({ type: "value", action: "include", key: "", value: valueInclude });
            }
            if (keyExclude) {
                filters.push({ type: "key", action: "exclude", key: keyExclude, value: "" });
            }
            if (valueExclude) {
                filters.push({ type: "value", action: "exclude", key: "", value: valueExclude });
            }

            return logs.filter(log => {
                return filters.every(filter => {
                    if (filter.type === "key") {
                        if (filter.action === "exclude") {
                            return !log.hasOwnProperty(filter.key);
                        } else if (filter.action === "include") {
                            return log.hasOwnProperty(filter.key);
                        }
                    } else if (filter.type === "value") {
                        // check all properties of log if one of their values contains the filter value
                        let isContain = Object.values(log).some(value => {
                            //return value.includes(filter.value);
                            return String(value).toLowerCase().includes(filter.value.toLowerCase());
                        });
                        if (filter.action === "exclude") {
                                return !isContain;
                        } else if (filter.action === "include") {
                            return isContain;
                        }
                    }

                    // Should not be reached? only with empty filters
                    // Default case (if filter doesn't match)
                    return true;
                });
            });
        }


        // Logs

        function renderLogs() {
            const container = document.getElementById("log-container");
            container.innerHTML = "";
            logs.forEach((log, logIndex) => {
                const logDiv = document.createElement("div");
                logDiv.classList.add("log-line");
                const entryDiv = document.createElement("div");
                entryDiv.classList.add("log-entry");
                Object.entries(log).forEach(([key, value]) => {
                    const keySpan = document.createElement("span");
                    keySpan.classList.add("log-key");
                    keySpan.textContent = key + ": ";
                    keySpan.dataset.logIndex = logIndex;
                    keySpan.dataset.key = key;
                    keySpan.onmouseenter = showPopupKey;
                    
                    const valueSpan = document.createElement("span");
                    valueSpan.classList.add("log-value");
                    valueSpan.textContent = value;
                    valueSpan.dataset.logIndex = logIndex;
                    valueSpan.dataset.key = key;
                    valueSpan.dataset.value = value;
                    valueSpan.onmouseenter = showPopupValue;
                    
                    entryDiv.appendChild(keySpan);
                    entryDiv.appendChild(valueSpan);
                });
                logDiv.appendChild(entryDiv);
                container.appendChild(logDiv);
            });
        }

        // Logs popup

        function popupInit() {
            document.getElementById("action-button-key-include").addEventListener("click", () => {
                addFilter("key", "include", currentLogEntry, currentKey, currentValue);
            });
            document.getElementById("action-button-key-exclude").addEventListener("click", () => {
                addFilter("key", "exclude", currentLogEntry, currentKey, currentValue);
            });
            document.getElementById("action-button-value-include").addEventListener("click", () => {
                addFilter("value", "include", currentLogEntry, currentKey, currentValue);
            });
            document.getElementById("action-button-value-exclude").addEventListener("click", () => {
                addFilter("value", "exclude", currentLogEntry, currentKey, currentValue);
            });
        }

        function showPopupKey(event) {
            showPopup(event, "key");
        }
        function showPopupValue(event) {
            showPopup(event, "value");
        }

        function showPopup(event, type) {
            if (popupShown) {
                realHidePopup();
                cancelHidePopup();
                popupShown = false;
            }
            
            clearTimeout(hideTimeout);
            popupName = "popup_" + type
            const popup = document.getElementById(popupName);
            popup.style.left = `${event.pageX + 5}px`;
            popup.style.top = `${event.pageY + 5}px`;
            popup.style.display = "block";
            
            currentLogEntry = event.target.dataset.logIndex;
            currentKey = event.target.dataset.key;
            currentValue = event.target.dataset.value || "";

            popupShown = true;

            hideTimeout = setTimeout(() => {
                document.getElementById("popup_key").style.display = "none";
                document.getElementById("popup_value").style.display = "none";
                popupShown = false;
            }, 1500);
        }

        function hidePopup() {
            hideTimeout = setTimeout(() => {
                realHidePopup();
                popupShown = false;
            }, 500);
        }

        function realHidePopup() {
            document.getElementById("popup_key").style.display = "none";
            document.getElementById("popup_value").style.display = "none";
        }

        function cancelHidePopup() {
            clearTimeout(hideTimeout);
        }

        // Main

        function refresh() {
            menuFiltersRefresh();
            logs = filterOrigLogs(logs_orig, filters);
            renderLogs();
        }

        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0]; // Get the selected file
            
            if (!file) {
                alert("No file selected!");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const fileContent = event.target.result;
                try {
                    const jsonData = JSON.parse(fileContent);
                    logs_orig = jsonData;
                    refresh();
                } catch (error) {
                    console.error("Invalid JSON file:", error);
                }
            };
            reader.readAsText(file);
        }

        popupInit();
        refresh()
    </script>
</body>
</html>
